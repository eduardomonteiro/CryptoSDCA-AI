{% extends "base.html" %}

{% block title %}Manager Dashboard - CryptoSDCA-AI{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1><i class="fas fa-tachometer-alt"></i> Manager Dashboard</h1>
            
            <!-- Bot Control -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-robot"></i> Bot Control</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <button class="btn btn-success btn-lg w-100 mb-2" onclick="startBot()">
                                <i class="fas fa-play"></i> Start Bot
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-warning btn-lg w-100 mb-2" onclick="pauseBot()">
                                <i class="fas fa-pause"></i> Pause Bot
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-danger btn-lg w-100 mb-2" onclick="stopBot()">
                                <i class="fas fa-stop"></i> Stop Bot
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-dark btn-lg w-100 mb-2" onclick="emergencySell()">
                                <i class="fas fa-exclamation-triangle"></i> Emergency Sell
                            </button>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-12">
                            <div class="alert alert-info">
                                <strong>Bot Status:</strong> <span id="botStatus">STOPPED</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Quick Stats -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h4 class="text-primary" id="totalProfit">$0.00</h4>
                            <p class="text-muted">Total Profit</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h4 class="text-success" id="activeOrders">0</h4>
                            <p class="text-muted">Active Orders</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h4 class="text-info" id="aiConsensus">N/A</h4>
                            <p class="text-muted">AI Consensus</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h4 class="text-warning" id="winRate">0%</h4>
                            <p class="text-muted">Win Rate</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Recent Activity -->
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-list"></i> Active Orders</h5>
                        </div>
                        <div class="card-body">
                            <div id="activeOrdersList">
                                <p class="text-muted text-center">No active orders</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-history"></i> Recent Trades</h5>
                        </div>
                        <div class="card-body">
                            <div id="recentTradesList">
                                <p class="text-muted text-center">No recent trades</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Load dashboard data on page load
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardData();
    // Refresh every 30 seconds
    setInterval(loadDashboardData, 30000);
});

async function loadDashboardData() {
    try {
        // Load bot status
        const statusResponse = await fetch('/api/trading/status');
        const statusData = await statusResponse.json();
        document.getElementById('botStatus').textContent = statusData.status || 'STOPPED';
        
        // Load trading statistics
        const statsResponse = await fetch('/api/trading/statistics');
        const statsData = await statsResponse.json();
        
        document.getElementById('totalProfit').textContent = `$${statsData.total_pnl || 0}`;
        document.getElementById('activeOrders').textContent = statsData.open_trades || 0;
        document.getElementById('winRate').textContent = `${statsData.win_rate || 0}%`;
        
        // Load active orders
        const ordersResponse = await fetch('/api/trading/trades?status=open');
        const ordersData = await ordersResponse.json();
        displayActiveOrders(ordersData);
        
        // Load recent trades
        const tradesResponse = await fetch('/api/trading/trades?limit=5');
        const tradesData = await tradesResponse.json();
        displayRecentTrades(tradesData);
        
    } catch (error) {
        console.error('Error loading dashboard data:', error);
    }
}

function displayActiveOrders(orders) {
    const container = document.getElementById('activeOrdersList');
    
    if (!orders || orders.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">No active orders</p>';
        return;
    }
    
    const html = orders.map(order => `
        <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
                <strong>${order.pair || 'N/A'}</strong><br>
                <small class="text-muted">${order.side || 'N/A'} - ${order.size || 'N/A'}</small>
            </div>
            <div class="text-end">
                <span class="badge bg-${order.status === 'open' ? 'warning' : 'secondary'}">${order.status || 'N/A'}</span><br>
                <small class="text-muted">$${order.price || 'N/A'}</small>
            </div>
        </div>
    `).join('');
    
    container.innerHTML = html;
}

function displayRecentTrades(trades) {
    const container = document.getElementById('recentTradesList');
    
    if (!trades || trades.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">No recent trades</p>';
        return;
    }
    
    const html = trades.map(trade => `
        <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
                <strong>${trade.pair || 'N/A'}</strong><br>
                <small class="text-muted">${trade.side || 'N/A'} - ${trade.size || 'N/A'}</small>
            </div>
            <div class="text-end">
                <span class="text-${trade.pnl >= 0 ? 'success' : 'danger'}">$${trade.pnl ? trade.pnl.toFixed(2) : 'N/A'}</span><br>
                <small class="text-muted">${trade.status || 'N/A'}</small>
            </div>
        </div>
    `).join('');
    
    container.innerHTML = html;
}

async function startBot() {
    try {
        const response = await fetch('/api/trading/start', { method: 'POST' });
        if (response.ok) {
            alert('Bot started successfully!');
            loadDashboardData();
        } else {
            const error = await response.json();
            alert('Error: ' + error.detail);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function pauseBot() {
    try {
        const response = await fetch('/api/trading/pause', { method: 'POST' });
        if (response.ok) {
            alert('Bot paused successfully!');
            loadDashboardData();
        } else {
            const error = await response.json();
            alert('Error: ' + error.detail);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function stopBot() {
    try {
        const response = await fetch('/api/trading/stop', { method: 'POST' });
        if (response.ok) {
            alert('Bot stopped successfully!');
            loadDashboardData();
        } else {
            const error = await response.json();
            alert('Error: ' + error.detail);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function emergencySell() {
    if (!confirm('Are you sure you want to emergency sell all positions? This action cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch('/api/trading/emergency-sell', { method: 'POST' });
        if (response.ok) {
            alert('Emergency sell executed successfully!');
            loadDashboardData();
        } else {
            const error = await response.json();
            alert('Error: ' + error.detail);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}
</script>
{% endblock %}
